<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Eyes of 3080 Chat</title>
<style>
:root {
  --uni-green: #006400;
  --bg: #f6f7f8;
  --card: #fff;
}
* { box-sizing: border-box; }
body {
  margin: 0;
  font-family: "Poppins", Arial, sans-serif;
  background: var(--bg);
  color: #222;
}

/* HEADER */
header.site-header {
  background: var(--uni-green);
  color: #fff;
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 12px 16px;
}
.brand {
  display: flex;
  align-items: center;
  gap: 10px;
}
.brand img {
  width: 40px;
  height: 40px;
  border-radius: 50%;
  object-fit: cover;
}
.brand h1 {
  margin: 0;
  font-size: 18px;
  font-weight: 700;
  color: #fff;
}
.header-actions {
  display: flex;
  align-items: center;
  gap: 12px;
}
.header-actions button {
  background: transparent;
  border: none;
  cursor: pointer;
}
.header-actions button img {
  width: 22px;
  height: 22px;
  filter: brightness(0); /* makes icons black */
}

/* BACK BUTTON */
.btn-back {
  background: transparent;
  color: #000;
  border: none;
  font-weight: 700;
  cursor: pointer;
  font-size: 15px;
}

/* PAGE SECTIONS */
main {
  padding-bottom: 60px; /* leave space for bottom nav */
}
section {
  display: none;
  padding: 16px;
}
section.active {
  display: block;
}



/* BOTTOM NAV */
.bottom-nav {
  position: fixed;
  bottom: 0;
  left: 0;
  width: 100%;
  background: #fff;
  border-top: 1px solid #ddd;
  display: flex;
  justify-content: space-around;
  z-index: 100;
}
.nav-item {
  border: none;
  background: none;
  flex: 1;
  text-align: center;
  padding: 8px 0;
  cursor: pointer;
}
.nav-item img {
  width: 22px;
  height: 22px;
  display: block;
  margin: 0 auto 4px;
  opacity: 0.6;
  transition: all 0.2s;
}
.nav-item span {
  font-size: 12px;
  color: #333;
}
.nav-item.active img {
  opacity: 1;
  transform: scale(1.1);
}
.nav-item.active span {
  color: var(--uni-green);
  font-weight: 600;
}

/* MODAL */
.modal {
  display: none;
  position: fixed;
  inset: 0;
  background: rgba(0, 0, 0, 0.4);
  justify-content: center;
  align-items: center;
  z-index: 1000;
}
.modal-content {
  background: #fff;
  padding: 20px;
  border-radius: 10px;
  width: 90%;
  max-width: 400px;
}
.modal-content h3 {
  margin-top: 0;
  text-align: center;
}
.modal-content input,
.modal-content select {
  width: 100%;
  padding: 10px;
  margin: 6px 0;
  border-radius: 8px;
  border: 1px solid #ccc;
}
.modal-content .btn-row {
  display: flex;
  justify-content: space-between;
  margin-top: 10px;
}
.modal-content button {
  padding: 8px 14px;
  border: none;
  border-radius: 6px;
  cursor: pointer;
}
.modal-content button#cancelAdd {
  background: #ccc;
}
.modal-content button[type="submit"] {
  background: var(--uni-green);
  color: #fff;
}

/* ======================
   üí¨ Chat UI (WhatsApp Style)
====================== */

/* User list vertical */
#userList {
  display: flex;
  flex-direction: column;
  padding: 0;
  margin: 0;
  overflow-y: auto;
  height: 100%;
}

.user-card {
  display: flex;
  align-items: center;
  gap: 12px;
  padding: 12px 16px;
  border-bottom: 1px solid #f0f0f0;
  cursor: pointer;
  transition: background 0.2s;
}

.user-card:hover {
  background: #f9f9f9;
}

.user-card img {
  width: 50px;
  height: 50px;
  border-radius: 50%;
  object-fit: cover;
}

.user-info {
  display: flex;
  flex-direction: column;
}

.user-name {
  font-weight: 600;
  font-size: 16px;
}

.last-msg {
  font-size: 13px;
  color: #777;
  margin-top: 2px;
}

/* Chat room full height */
.chat-room {
  display: flex;
  flex-direction: column;
  height: 100vh;
  background: #e5ddd5; /* WhatsApp-like background */
  position: relative;
}

/* Faint slanted watermark */
.chat-room::before {
  content: "EYES OF 3080";
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%) rotate(-30deg); /* slanted */
  font-size: 60px;
  color: rgba(0,0,0,0.03);
  pointer-events: none;
  user-select: none;
  white-space: nowrap;
  z-index: 0;
}

/* Chat header */
.chat-header {
  display: flex;
  align-items: center;
  gap: 12px;
  padding: 12px 16px;
  background: #f7f7f7;
  border-bottom: 1px solid #ddd;
  position: sticky;
  top: 0;
  z-index: 10;
}

.chat-header img {
  width: 40px;
  height: 40px;
  border-radius: 50%;
  object-fit: cover;
}

.back-btn {
  background: transparent;
  border: none;
  font-size: 22px;
  cursor: pointer;
  margin-right: 8px;
}

/* Messages area */
.messages {
  flex: 1;               /* fill available space above input */
  overflow-y: auto;
  padding: 12px 16px;
  display: flex;
  flex-direction: column;
  gap: 8px;
  scroll-behavior: smooth;
  z-index: 1;
}

/* Message bubbles */
.msg {
  max-width: 75%;
  padding: 10px 14px;
  border-radius: 18px;
  word-wrap: break-word;
  line-height: 1.4;
  font-size: 14px;
  position: relative;
}

.msg.sent {
  background: #dcf8c6; /* WhatsApp green bubble */
  align-self: flex-end;
  border-bottom-right-radius: 4px;
}

.msg.received {
  background: #fff;
  align-self: flex-start;
  border-bottom-left-radius: 4px;
}

/* Tick indicators (online/offline) */
.msg.sent::after {
  content: "‚úî";  /* single tick default */
  font-size: 12px;
  position: absolute;
  bottom: 4px;
  right: 6px;
  color: gray;
}

.msg.sent.online::after {
  content: "‚úî‚úî"; /* double tick if online */
  color: #128c7e;
}

/* Chat input at bottom */
.chat-input {
  display: flex;
  align-items: center;
  gap: 8px;
  padding: 10px 16px;
  background: #f7f7f7;
  border-top: 1px solid #ddd;
  flex-shrink: 0;
}

.chat-input input {
  flex: 1;
  padding: 10px 14px;
  border-radius: 20px;
  border: 1px solid #ccc;
  outline: none;
  font-size: 14px;
}

.send-btn {
  background: #128c7e; /* WhatsApp green */
  border: none;
  width: 42px;
  height: 42px;
  border-radius: 50%;
  display: flex;
  justify-content: center;
  align-items: center;
  cursor: pointer;
}

.send-btn img {
  width: 20px;
  height: 20px;
  filter: invert(1);
}

/* Scrollbar styling */
.messages::-webkit-scrollbar {
  width: 6px;
}

.messages::-webkit-scrollbar-thumb {
  background: rgba(0,0,0,0.2);
  border-radius: 3px;
}

/* Calls */
.call-item {
  display: flex;
  align-items: center;
  justify-content: space-between;
  background: #fff;
  border-radius: 10px;
  padding: 10px 14px;
  margin-bottom: 10px;
  box-shadow: 0 1px 2px rgba(0,0,0,0.1);
}
.call-item img:first-child {
  width: 42px;
  height: 42px;
  border-radius: 50%;
}
.call-info {
  flex: 1;
  margin-left: 12px;
}
.call-info h4 {
  margin: 0;
  font-size: 15px;
}
.call-info .muted {
  font-size: 12px;
  color: #777;
}
.call-icon {
  width: 22px;
  height: 22px;
  opacity: 0.7;
}

.unread-badge {
  background: #128c7e; /* WhatsApp green */
  color: #fff;
  font-size: 12px;
  font-weight: bold;
  padding: 2px 6px;
  border-radius: 12px;
  position: absolute;
  top: 10px;
  right: 10px;
  display: none; /* hidden if 0 */
}
.user-card {
  position: relative; /* needed for the badge */
}

/* ======================
   üí¨ Updates / Recent Activity
====================== */
#updates {
  padding: 12px 16px;
}

.update-card {
  display: flex;
  align-items: center;
  gap: 12px;
  background: #fefefe;
  border-radius: 12px;
  padding: 10px 14px;
  margin-bottom: 12px;
  box-shadow: 0 2px 4px rgba(0,0,0,0.05);
  cursor: pointer;
  transition: transform 0.1s, box-shadow 0.2s;
}

.update-card:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 8px rgba(0,0,0,0.1);
}

.update-card img {
  width: 48px;
  height: 48px;
  border-radius: 50%;
  object-fit: cover;
}

.update-info {
  display: flex;
  flex-direction: column;
  flex: 1;
}

.update-title {
  font-weight: 600;
  font-size: 15px;
  color: #111;
  margin-bottom: 2px;
}

.update-text {
  font-size: 13px;
  color: #555;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
}

.update-time {
  font-size: 11px;
  color: #999;
  margin-left: auto;
  white-space: nowrap;
}

.section {
  padding: 12px 16px;
}

.section {
  padding: 12px 16px;
}

/* ===== SETTINGS SECTION ===== */
.settings-section {
  padding: 16px;
  background: #f7f7f7;
  min-height: 100%;
}

.settings-section h3 {
  margin-bottom: 16px;
  font-size: 18px;
  font-weight: 600;
}

/* Individual setting items */
.settings-item {
  background: #fff;
  border-radius: 12px;
  padding: 14px 16px;
  margin-bottom: 12px;
  box-shadow: 0 1px 3px rgba(0,0,0,0.1);
  display: flex;
  flex-direction: column;
  gap: 10px;
}

/* Avatar Section */
.avatar-preview {
  display: flex;
  align-items: center;
  gap: 12px;
}

.avatar-preview img {
  width: 50px;
  height: 50px;
  border-radius: 50%;
  object-fit: cover;
  border: 2px solid #128c7e;
}

#changeAvatarBtn {
  background: #128c7e;
  color: #fff;
  border: none;
  padding: 6px 12px;
  border-radius: 8px;
  cursor: pointer;
  font-weight: 600;
  transition: background 0.2s;
}

#changeAvatarBtn:hover {
  background: #0f765e;
}

/* Theme Section */
.theme-options {
  display: flex;
  gap: 12px;
  flex-wrap: wrap;
}

.theme-btn {
  flex: 1;
  min-width: 80px;
  padding: 12px 0;
  border-radius: 12px;
  border: none;
  cursor: pointer;
  color: #fff;
  font-weight: 600;
  text-align: center;
  transition: transform 0.1s, opacity 0.2s;
}

.theme-btn:hover {
  transform: scale(1.05);
  opacity: 0.9;
}

/* Chat storage / Clear all chats button */
#clearAllChatsBtn {
  background: #f44336;
  color: #fff;
  border: none;
  padding: 10px 0;
  border-radius: 12px;
  cursor: pointer;
  font-weight: 600;
  transition: background 0.2s;
}

#clearAllChatsBtn:hover {
  background: #d32f2f;
}

/* Chat Room Watermark */
.chat-room::before {
  content: "EYES OF 3080";
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%) rotate(-30deg);
  font-size: 60px;
  color: var(--watermark-color, rgba(0,0,0,0.03));
  pointer-events: none;
  user-select: none;
  z-index: 0;
}

/* Context menu for messages */
.msg-menu {
  position: absolute;
  background: #fff;
  border: 1px solid #ccc;
  border-radius: 8px;
  box-shadow: 0 2px 6px rgba(0,0,0,0.2);
  display: none;
  z-index: 1000;
  padding: 6px 0;
  min-width: 150px;
  font-size: 14px;
}

.msg-menu button {
  width: 100%;
  padding: 8px 12px;
  background: none;
  border: none;
  text-align: left;
  cursor: pointer;
}

.msg-menu button:hover {
  background: #f0f0f0;
}

/* Timestamp inside message bubble */
.msg .msg-time {
  display: block;
  font-size: 11px;
  color: rgba(0,0,0,0.4);
  text-align: right;
  margin-top: 4px;
}

</style>
</head>
<body>

<!-- ===== HEADER ===== -->
<header class="site-header">
  <div class="brand">
    <img src="https://i.postimg.cc/mD4BWXCk/6a8f3e57-3d27-47f5-9b5e-22a7070fc442.jpg" />
    <h1>EYES OF 3080</h1>
  </div>
  <div class="header-actions">
    <button id="addUserBtn"><img src="https://cdn-icons-png.flaticon.com/512/992/992651.png" alt="+" /></button>
<button class="btn-back" onclick="window.location.href='3080.html'">Back</button>
  </div>
</header>

<!-- ===== MAIN CONTENT ===== -->
<main>
  <!-- üí¨ CHATS SECTION -->
  <section id="chats" class="active">

    <!-- =======================
         USER LIST VIEW
    ======================= -->
    <div id="userListView">
      <div id="userList"></div>
    </div>

    <!-- =======================
         CHAT ROOM VIEW (hidden initially)
    ======================= -->
    <div class="chat-room" id="chatRoom" style="display:none; position: relative;">

      <!-- Chat Header -->
      <div class="chat-header">
        <button id="backToUsers" class="back-btn">‚Üê</button>
        <img id="roomAvatar" src="https://cdn-icons-png.flaticon.com/512/3135/3135715.png" alt="avatar">
        <h3 id="roomName">Select a Chat</h3>
      </div>

      <!-- Chat Messages -->
      <div id="messages" class="messages"></div>

      <!-- Chat Input -->
      <div class="chat-input">
        <input id="msgInput" type="text" placeholder="Type a message..." autocomplete="off">
        <button id="sendBtn" class="send-btn">
          <img src="https://cdn-icons-png.flaticon.com/512/724/724954.png" alt="Send">
        </button>
      </div>

      <!-- Message Options Menu -->
      <div id="msgMenu" class="msg-menu" style="display:none; position:absolute; background:#fff; box-shadow:0 2px 6px rgba(0,0,0,0.2); border-radius:8px; z-index:100;">
        <button id="copyMsg">Copy Message</button>
        <button id="editMsg">Edit Message</button>
        <button id="deleteMe">Delete for Me</button>
        <button id="deleteEveryone">Delete for Everyone</button>
        <button id="pinMsg">Pin Message</button>
        <button id="clearChat">Clear Chat</button>
        <button id="deleteConv">Delete Conversation</button>
      </div>

      <!-- Faint Watermark -->
      <div class="chat-watermark">EYES OF 3080</div>

    </div>
  </section>



  <section id="calls">
  <h2>üìû Recent Calls</h2>
  <div class="call-item">
    <img src="https://cdn-icons-png.flaticon.com/512/3135/3135715.png" alt="user">
    <div class="call-info">
      <h4>Joy</h4>
      <p class="muted">Missed ‚Ä¢ Yesterday, 7:42 PM</p>
    </div>
    <img class="call-icon" src="https://cdn-icons-png.flaticon.com/512/597/597177.png" alt="Call">
  </div>
  <div class="call-item">
    <img src="https://cdn-icons-png.flaticon.com/512/1946/1946429.png" alt="user">
    <div class="call-info">
      <h4>Tunde</h4>
      <p class="muted">Outgoing ‚Ä¢ Today, 10:20 AM</p>
    </div>
    <img class="call-icon" src="https://cdn-icons-png.flaticon.com/512/597/597177.png" alt="Call">
  </div>
</section>

<section id="updates">
  <h3>Updates</h3>
  <div id="updatesList">
    <!-- Example update item -->
    <div class="update-card">
      <img src="https://i.postimg.cc/fbrgvkvP/IMG-1194.jpg" alt="avatar">
      <div class="update-info">
        <span class="update-title">Joy sent a new message</span>
        <span class="update-time">10:45 AM</span>
      </div>
    </div>
  </div>
</section>

<!-- ============================
     üåø SETTINGS / PROFILE SECTION
============================ -->
<section id="settings" class="settings-section">
  <h3>Settings</h3>

  <!-- Avatar -->
  <div class="settings-item">
    <label>Avatar</label>
    <div class="avatar-preview">
      <img id="userAvatarPreview" src="https://cdn-icons-png.flaticon.com/512/3135/3135715.png" alt="avatar">
      <input type="file" id="avatarInput" accept="image/*" style="display:none;">
    </div>
  </div>

  <!-- Chat Theme -->
  <div class="settings-item">
    <label>Chat Theme</label>
    <div class="theme-options">
      <button class="theme-btn" data-theme="default" style="background:#e5ddd5;">Default</button>
      <button class="theme-btn" data-theme="blue" style="background:#d0e6f7;">Blue</button>
      <button class="theme-btn" data-theme="pink" style="background:#f7d0e6;">Pink</button>
      <button class="theme-btn" data-theme="green" style="background:#d0f7d6;">Green</button>
    </div>
  </div>

  <!-- Clear Chat / Storage -->
  <div class="settings-item">
    <label>Chat Storage</label>
    <button id="clearAllChatsBtn">Clear All Chats</button>
  </div>
</section>
</main>

<!-- ===== BOTTOM NAVIGATION ===== -->
<nav class="bottom-nav">
  <button class="nav-item active" data-target="chats">
    <img src="https://cdn-icons-png.flaticon.com/512/134/134914.png" />
    <span>Chats</span>
  </button>
  <button class="nav-item" data-target="calls">
    <img src="https://cdn-icons-png.flaticon.com/512/597/597177.png" />
    <span>Calls</span>
  </button>
  <button class="nav-item" data-target="updates">
    <img src="https://cdn-icons-png.flaticon.com/512/1828/1828859.png" />
    <span>Updates</span>
  </button>
  <button class="nav-item" data-target="settings">
    <img src="https://cdn-icons-png.flaticon.com/512/126/126472.png" />
    <span>Settings</span>
  </button>
</nav>

<!-- ===== ADD USER MODAL ===== -->
<div class="modal" id="addUserModal">
  <div class="modal-content">
    <h3>Start New Chat</h3>
    <form id="addUserForm">
      <!-- Removed Full Name input since we'll fetch it from Auth -->
      <input type="email" id="userEmail" placeholder="User Email Address" required>

      <select id="userCampus" required>
        <option value="">Select Campus</option>
        <option>Osogbo</option>
        <option>Okuku</option>
        <option>Ikire</option>
        <option>Ejigbo</option>
        <option>Ifetedo</option>
        <option>Ipetu-Ijesa</option>
      </select>

      <div class="btn-row">
        <button type="button" id="cancelAdd">Cancel</button>
        <button type="submit">Add User</button>
      </div>
    </form>
  </div>
</div>




<!-- ===== JS ===== -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/supabase.min.js"></script>
<script>
  const SUPABASE_URL = "https://vtpsruejncfykiazrfsx.supabase.co";
  const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZ0cHNydWVqbmNmeWtpYXpyZnN4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY3NDA5NzQsImV4cCI6MjA3MjMxNjk3NH0.UV55gbsSAgnyolxJhIYTaJUpvoJFsJn0_-LMNwhwAK0";
  const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
</script>

<script>

document.addEventListener("DOMContentLoaded", () => {

  // --- NAVIGATION ---
  const navItems = document.querySelectorAll(".nav-item");
  const sections = document.querySelectorAll("main section");
  navItems.forEach(item => {
    item.addEventListener("click", () => {
      navItems.forEach(btn => btn.classList.remove("active"));
      sections.forEach(sec => sec.classList.remove("active"));
      item.classList.add("active");
      document.getElementById(item.dataset.target).classList.add("active");
    });
  });

  // --- ELEMENTS ---
  const userListContainer = document.getElementById("userList");
  const chatRoom = document.querySelector(".chat-room");
  const roomName = document.getElementById("roomName");
  const roomAvatar = document.getElementById("roomAvatar");
  const messagesEl = document.getElementById("messages");
  const backBtn = document.getElementById("backToUsers");
  const msgInput = document.getElementById("msgInput");
  const sendBtn = document.getElementById("sendBtn");

  let activeUser = null;
  let users = [];

  // --- FETCH USERS FROM AUTH + CAMPUS INFO ---
  async function fetchUsers() {
    // Fetch all users from Supabase Auth
    const { data: authUsers, error: authError } = await supabase.auth.admin.listUsers();
    if (authError) return console.error(authError);

    // Fetch campuses from your 'user_campus' table
    const { data: campusData, error: campusError } = await supabase.from("user_campus").select("*");
    if (campusError) return console.error(campusError);

    // Merge auth users with campus info
    users = authUsers.map(u => {
      const campusRecord = campusData.find(c => c.user_id === u.id);
      return {
        id: u.id,
        email: u.email,
        name: u.user_metadata?.full_name || u.email.split("@")[0],
        campus: campusRecord?.campus || "Unknown",
        img: u.user_metadata?.avatar_url || "https://cdn-icons-png.flaticon.com/512/3135/3135715.png"
      };
    });

    renderUsers();
  }

  // --- RENDER USERS ---
  function renderUsers() {
    userListContainer.innerHTML = "";
    users.forEach(u => {
      const card = document.createElement("div");
      card.className = "user-card";
      card.innerHTML = `
        <img src="${u.img}" alt="avatar">
        <div class="user-info">
          <span class="user-name">${u.name}</span>
          <small class="campus-name">(${u.campus})</small>
  <span class="unread-badge" id="unread-${u.id}">0</span>
        </div>
      `;
      card.onclick = () => openChat(u);
      userListContainer.appendChild(card);
    });
  }

  // --- OPEN CHAT ---
async function openChat(u) {
  activeUser = u;
  roomName.textContent = u.name + ` (${u.campus})`;
  roomAvatar.src = u.img;
  messagesEl.innerHTML = ""; // clear previous messages
  chatRoom.style.display = "block";
  userListContainer.parentElement.style.display = "none";

  const currentUserId = supabase.auth.user()?.id;

  // Fetch all messages between current user and selected user
  const { data: msgs, error: msgError } = await supabase
    .from("messages")
    .select("*")
    .or(
      `user_id.eq.${u.id},sender_id.eq.${u.id}`
    )
    .order("created_at", { ascending: true });

  if (msgError) return console.error(msgError);

  // Render messages
  msgs.forEach(msg => {
    const sent = msg.sender_id === currentUserId; // if current user sent it
    addMessageToDOM(msg, sent);
  });

  // Mark all messages from this user as read
  const { error: readError } = await supabase
    .from("messages")
    .update({ read: true })
    .eq("sender_id", u.id)
    .eq("read", false);

  if (readError) console.error(readError);

  // Update unread badge
  updateUnreadCounts();
}

  // --- BACK BUTTON ---
  if(backBtn){
    backBtn.onclick = () => {
      chatRoom.style.display = "none";
      userListContainer.parentElement.style.display = "block";
      activeUser = null;
    };
  }

// --- UPDATES SECTION ---
const updatesContainer = document.getElementById("updates");

// Fetch latest messages for updates
async function fetchUpdates() {
  if (!updatesContainer) return;

  // Get last 20 messages across all users (or adjust limit)
  const { data: messages, error } = await supabase
    .from("messages")
    .select(`*, user:user_id (id, email, name, img)`) // join user info
    .order("created_at", { ascending: false })
    .limit(20);

  if (error) {
    console.error("Error fetching updates:", error);
    return;
  }

  updatesContainer.innerHTML = ""; // clear previous

  messages.forEach(msg => {
    const time = new Date(msg.created_at);
    const hours = time.getHours() % 12 || 12;
    const minutes = time.getMinutes().toString().padStart(2, "0");
    const ampm = time.getHours() >= 12 ? "PM" : "AM";
    const timeString = `${hours}:${minutes} ${ampm}`;

    const card = document.createElement("div");
    card.className = "update-card";
    card.innerHTML = `
      <img src="${msg.user?.img || 'https://cdn-icons-png.flaticon.com/512/3135/3135715.png'}" alt="avatar">
      <div class="update-info">
        <span class="update-title">${msg.user?.name || 'Unknown'}</span>
        <span class="update-text">${msg.text}</span>
      </div>
      <span class="update-time">${timeString}</span>
    `;

    // Optional: click to open chat with that user
    card.onclick = () => openChat(msg.user);

    updatesContainer.appendChild(card);
  });
}

// Call this on page load or after sending a message
fetchUpdates();

  // --- SEND MESSAGE ---
  sendBtn.addEventListener("click", async () => {
    const txt = msgInput.value.trim();
    if (!txt || !activeUser) return;

    const newMsg = {
      sender_id: supabase.auth.user().id,
      user_id: activeUser.id,
      text: txt,
      created_at: new Date().toISOString()
    };

    const { data, error } = await supabase.from("messages").insert([newMsg]);
    if (error) return console.error(error);

    addMessageToDOM(data[0], true);
    msgInput.value = "";
    messagesEl.scrollTop = messagesEl.scrollHeight;
  });

  msgInput.addEventListener("keypress", (e) => {
    if(e.key === "Enter") sendBtn.click();
  });

  // --- ADD MESSAGE TO DOM ---
  function addMessageToDOM(msg, sent) {
    const div = document.createElement("div");
    div.className = sent ? "msg sent" : "msg received";

    const time = new Date(msg.created_at);
    const hours = time.getHours() % 12 || 12;
    const minutes = time.getMinutes().toString().padStart(2, "0");
    const ampm = time.getHours() >= 12 ? "PM" : "AM";
    const timeString = `${hours}:${minutes} ${ampm}`;

    div.innerHTML = `<div class="bubble">${msg.text}<span class="msg-time">${timeString}</span></div>`;
    messagesEl.appendChild(div);
  }

  // --- ADD USER MODAL ---
  const addBtn = document.getElementById("addUserBtn");
  const modal = document.getElementById("addUserModal");
  const cancelAdd = document.getElementById("cancelAdd");
  const form = document.getElementById("addUserForm");

  addBtn.addEventListener("click", () => modal.style.display = "flex");
  cancelAdd.addEventListener("click", () => modal.style.display = "none");

  form.addEventListener("submit", async (e) => {
    e.preventDefault();
    const email = document.getElementById("userEmail").value.trim();
    const campus = document.getElementById("userCampus").value;
    if(!email || !campus) return alert("Email and campus required");

    // Check if user exists in Auth
    const { data: authUser, error: authError } = await supabase.auth.admin.getUserByEmail(email);
    if (authError || !authUser) return alert("User does not exist in Supabase Auth");

    // Add campus info
    const { data, error } = await supabase.from("user_campus").upsert({
      user_id: authUser.id,
      campus
    });

    if (error) return console.error(error);

    fetchUsers();
    modal.style.display = "none";
    form.reset();
  });

document.addEventListener("DOMContentLoaded", () => {
  // --- AVATAR CHANGE ---
  const changeAvatarBtn = document.getElementById("changeAvatarBtn");
  const avatarInput = document.getElementById("avatarInput");
  const userAvatarPreview = document.getElementById("userAvatarPreview");

  changeAvatarBtn.addEventListener("click", () => avatarInput.click());

  avatarInput.addEventListener("change", (e) => {
    const file = e.target.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = (event) => {
      userAvatarPreview.src = event.target.result;

      // Optionally, upload to Supabase Storage
      // Example: supabase.storage.from("avatars").upload(`avatars/${user.id}.png`, file)
    };
    reader.readAsDataURL(file);
  });

  // --- CHAT THEME SELECTION ---
  const themeBtns = document.querySelectorAll(".theme-btn");

  themeBtns.forEach((btn) => {
    btn.addEventListener("click", () => {
      // Set chat room background
      const themeColor = btn.dataset.color || "#e5ddd5";
      document.querySelector(".chat-room").style.background = themeColor;

      // Update watermark color dynamically
      document.querySelector(".chat-room").style.setProperty(
        "--watermark-color",
        btn.dataset.watermark || "rgba(0,0,0,0.03)"
      );

      // Optional: Save theme to Supabase user metadata
      // supabase.auth.updateUser({ data: { theme: themeColor } })
    });
  });

  // --- CLEAR ALL CHATS ---
  const clearChatsBtn = document.getElementById("clearAllChatsBtn");
  const messagesEl = document.getElementById("messages");

  clearChatsBtn.addEventListener("click", async () => {
    if (!confirm("Are you sure you want to clear all chats?")) return;

    messagesEl.innerHTML = "";

    // Optionally clear from Supabase DB
    // await supabase.from("messages").delete().eq("user_id", activeUser.id);
  });
});

  // --- INITIALIZE ---
  fetchUsers();
});

</script>
</body>
</html>