<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>CBT Exam | EYES OF 3080</title>

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
}

body {
  font-family: Segoe UI, Tahoma, sans-serif;
  background: #f4f6f5;
}

/* HEADER */
header{
  background: linear-gradient(135deg,#2d5016,#4a7c2a);
  color:#fff;
  padding: 15px 20px;
  display: flex;
  align-items: center;
  justify-content: space-between;
  position: sticky;
  top:0;
  z-index: 1000;
  box-shadow: 0 4px 10px rgba(0,0,0,0.2);
}

.logo-wrap{
  display:flex;
  align-items:center;
  gap:12px;
  text-decoration:none;
}

.logo-img{
  width:45px;
  height:45px;
  border-radius:0;
  border:2px solid #fff;
  object-fit:cover;
}

.logo-text{
  font-size:1.6rem;
  font-weight:bold;
  color:#fff;
  letter-spacing:1px;
}

.user-icon{
  font-size:1.8rem;
}

/* MAIN */
.container {
  max-width: 900px;
  margin: 35px auto;
  padding: 0 20px;
}

.card {
  background: #fff;
  border-radius: 18px;
  padding: 26px;
  box-shadow: 0 12px 35px rgba(0, 0, 0, 0.08);
  margin-bottom: 20px;
}

.greeting {
  font-size: 1.4rem;
  color: #2d5016;
  font-weight: 600;
  margin-bottom: 15px;
}

/* CBT */
.cbt-header {
  display: flex;
  justify-content: space-between;
  margin-bottom: 18px;
}

.course-title {
  font-weight: 700;
  color: #2d5016;
}

.question-text {
  margin: 20px 0;
  font-size: 1.05rem;
}

/* OPTIONS */
.options {
  display: flex;
  flex-direction: column;
  gap: 14px;
}

.option {
  border: 1px solid #e5e7eb;
  border-radius: 14px;
  padding: 14px;
  cursor: pointer;
  transition: 0.2s;
}

.option:hover {
  background: #f0fdf4;
}

.option.selected {
  background: #ecfdf5;
  border-color: #22c55e;
}

/* CONTROLS */
.controls {
  display: flex;
  justify-content: space-between;
  margin-top: 26px;
}

.btn {
  border: none;
  padding: 13px 26px;
  border-radius: 14px;
  cursor: pointer;
  font-weight: 700;
}

.btn-next {
  background: linear-gradient(135deg, #2d5016, #22c55e);
  color: #fff;
}

/* NO QUESTIONS */
.notice-card {
  display: none;
  text-align: center;
  background: #f0fdf4;
  border-left: 6px solid #22c55e;
  padding: 20px;
}

.notice-icon {
  font-size: 3.2rem;
  color: #22c55e;
  margin-bottom: 12px;
}

/* RESULT */
.result-card {
  display: none;
  text-align: center;
  background: #f0fdf4;
  border-left: 6px solid #22c55e;
}

.result-card h2 {
  color: #166534;
  margin-bottom: 10px;
}

.score {
  font-size: 2.6rem;
  font-weight: 800;
  color: #22c55e;
  margin: 12px 0;
}

.dashboard-btn {
  margin-top: 22px;
  display: inline-block;
  padding: 14px 28px;
  background: linear-gradient(135deg, #2d5016, #22c55e);
  color: #fff;
  text-decoration: none;
  border-radius: 16px;
  font-weight: 700;
  margin-right: 10px;
}
</style>
</head>

<body>

<header>
  <a href="news.html" class="logo-wrap">
    <img src="https://zvnovocoayqomdilidte.supabase.co/storage/v1/object/public/uploads/6a8f3e57-3d27-47f5-9b5e-22a7070fc442.jpeg" class="logo-img">
    <span class="logo-text">EYES OF 3080</span>
  </a>

  <div>
    <a href="dashboard.html" title="Dashboard">
      <i class="fa fa-user-circle user-icon" style="font-size:1.8rem; color:#fff;"></i>
    </a>
  </div>
</header>

<main class="container">

  <div class="greeting" id="greeting">Welcome!</div>

  <!-- NO QUESTIONS -->
  <div class="card notice-card" id="noQuestionsCard">
    <img src="https://zvnovocoayqomdilidte.supabase.co/storage/v1/object/public/uploads/6a8f3e57-3d27-47f5-9b5e-22a7070fc442.jpeg" width="60" alt="No Questions Icon" style="margin-bottom:12px;">
    <h3 style="color:#166534; margin-top:10px; font-weight:700;">No questions available</h3>
    <p style="color:#14532d; margin-top:6px;">
      Questions for this course/file are not available yet.<br>
      Please check back later.
    </p>
    <a href="cbt_welcome.html" id="goBackBtn" class="btn btn-next" style="margin-top:15px; display:inline-block;">Go Back</a>
  </div>

  <!-- EXAM -->
  <div class="card" id="examCard">
    <div class="cbt-header">
      <div class="course-title" id="courseTitle"></div>
      <div id="progress"></div>
    </div>

    <div class="question-text" id="questionText"></div>
    <div class="options" id="options"></div>

    <div class="controls">
      <button class="btn" id="prevBtn">Previous</button>
      <button class="btn btn-next" id="nextBtn">Next</button>
    </div>
  </div>

  <!-- RESULT -->
  <div class="card result-card" id="resultCard">
    <h2>CBT Completed </h2>
    <p>Your Score</p>
    <div class="score" id="finalScore"></div>
    
    <!-- REVIEW BUTTON -->
    <button class="dashboard-btn" id="reviewBtn">Review Answers →</button>
    <a href="dashboard.html" class="dashboard-btn" id="dashboardBtn">Go to Dashboard →</a>
  </div>

</main>

<script>
document.addEventListener("DOMContentLoaded", async () => {

  const supabaseClient = supabase.createClient(
    "https://zvnovocoayqomdilidte.supabase.co",
    "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inp2bm92b2NvYXlxb21kaWxpZHRlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQwMDM2OTgsImV4cCI6MjA3OTU3OTY5OH0.PcpwASQ3RBRoQVIglxKz-yM3iuYMZMtyQJBh8QNHad8"
  );

  /* ================= ELEMENTS ================= */
  const greeting = document.getElementById("greeting");
  const courseTitle = document.getElementById("courseTitle");
  const progress = document.getElementById("progress");
  const questionText = document.getElementById("questionText");
  const optionsDiv = document.getElementById("options");
  const examCard = document.getElementById("examCard");
  const noQuestionsCard = document.getElementById("noQuestionsCard");
  const resultCard = document.getElementById("resultCard");
  const finalScore = document.getElementById("finalScore");
  const prevBtn = document.getElementById("prevBtn");
  const nextBtn = document.getElementById("nextBtn");
  const reviewBtn = document.getElementById("reviewBtn");
  const dashboardBtn = document.getElementById("dashboardBtn");
  const goBackBtn = document.getElementById("goBackBtn");

  /* ================= GET COURSE ================= */
  const storedCourse = localStorage.getItem("cbt_course");
  if (!storedCourse) {
    alert("No course selected");
    window.location.href = "cbt-welcome.html";
    return;
  }

  const course = JSON.parse(storedCourse);
  const courseCode = course.course_code.trim().toUpperCase();
  const fileTitle = course.file_title ? course.file_title.trim() : null;

  /* ================= AUTH ================= */
  const { data: { user } } = await supabaseClient.auth.getUser();
  if (!user) {
    window.location.href = "login.html";
    return;
  }

  /* ================= PROFILE ================= */
  const { data: profile } = await supabaseClient
    .from("profiles")
    .select("full_name, level")
    .eq("id", user.id)
    .single();

  if (!profile) {
    alert("Profile not found");
    return;
  }

  greeting.textContent = `Welcome, ${profile.full_name}`;
  courseTitle.textContent = courseCode;

  /* ================= FETCH QUESTIONS ================= */
  const { data: questions, error } = await supabaseClient
    .from("cbt_questions")
    .select("id, question, option_a, option_b, option_c, option_d, correct_option")
    .eq("course_code", courseCode)
    .eq("level", profile.level)
    .eq("file_title", fileTitle);

  if (error || !questions || questions.length === 0) {
    examCard.style.display = "none";
    noQuestionsCard.style.display = "block";
    return;
  }

  let index = 0;
  let answers = {}; // store selected LETTER

  /* ================= RENDER ================= */
  function render() {
    const q = questions[index];
    progress.textContent = `Question ${index + 1} of ${questions.length}`;
    questionText.textContent = q.question;
    optionsDiv.innerHTML = "";

    ["A", "B", "C", "D"].forEach(letter => {
      const opt = document.createElement("div");
      opt.className = "option";
      opt.textContent = `${letter}. ${q["option_" + letter.toLowerCase()] || ""}`;

      if (answers[q.id] === letter) opt.classList.add("selected");

      opt.onclick = () => {
        document.querySelectorAll(".option").forEach(o => o.classList.remove("selected"));
        opt.classList.add("selected");
        answers[q.id] = letter;
      };

      optionsDiv.appendChild(opt);
    });

    prevBtn.style.display = index === 0 ? "none" : "inline-block";
    nextBtn.textContent = index === questions.length - 1 ? "Submit" : "Next";
  }

  /* ================= CONTROLS ================= */
  prevBtn.onclick = () => {
    if (index > 0) {
      index--;
      render();
    }
  };

  nextBtn.onclick = async () => {
    if (!answers[questions[index].id]) {
      alert("Please select an option");
      return;
    }

    if (index < questions.length - 1) {
      index++;
      render();
      return;
    }

    /* ================= SUBMIT & SCORE ================= */
    let score = 0;

    questions.forEach(q => {
      const selectedLetter = answers[q.id];
      if (!selectedLetter) return;

      const selectedText = q["option_" + selectedLetter.toLowerCase()] || "";
      const correctText = q.correct_option || "";

      if (selectedText.trim().toLowerCase() === correctText.trim().toLowerCase()) {
        score++;
      }
    });

    examCard.style.display = "none";
    resultCard.style.display = "block";
    finalScore.textContent = `${score} / ${questions.length}`;

    /* ================= SAVE FOR REVIEW ================= */
    localStorage.setItem(
      "userAnswers",
      JSON.stringify(
        questions.map(q => {
          const selectedLetter = answers[q.id] || null;
          return {
            question: q.question,
            options: {
              A: q.option_a,
              B: q.option_b,
              C: q.option_c,
              D: q.option_d
            },
            selected_option: selectedLetter,
            selected_text: selectedLetter
              ? q["option_" + selectedLetter.toLowerCase()]
              : null,
            correct_option: q.correct_option
          };
        })
      )
    );

    /* ================= SAVE RESULT TO SUPABASE ================= */
    try {
      const { data, error } = await supabaseClient.from("cbt_results").insert([
        {
          user_id: user.id,
          course_code: courseCode,
          file_title: fileTitle,
          score: score,
          taken_at: new Date().toISOString()
        }
      ]);
      if (error) console.error("Supabase insert error:", error);
    } catch (err) {
      console.error("Unexpected error saving result:", err);
    }
  };

  /* ================= BUTTONS ================= */
  reviewBtn.onclick = () => window.location.href = "cbt-review.html";
  dashboardBtn.onclick = () => {
    localStorage.removeItem("cbt_course");
    window.location.href = "dashboard.html";
  };
  goBackBtn.onclick = () => {
    localStorage.removeItem("cbt_course");
    window.location.href = "cbt-welcome.html";
  };

  render();
});
</script>

</body>
</html>


























