<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>FRIENDS - Eyes of 3080</title>
<style>
/* ====== GENERAL RESET ====== */
* { margin:0; padding:0; box-sizing:border-box; font-family: Arial, sans-serif; }

/* ====== HEADER ====== */
.header {
  display:flex;
  align-items:center;
  padding:10px 15px;
  background:#e6f4ea;
  border-bottom:2px solid #39b54a;
  position: sticky;
  top:0;
  z-index:100;
}
.hamburger { font-size:24px; background:none; border:none; color:#0f3d0f; cursor:pointer; margin-right:10px; }
.header-logo { width:40px; margin-right:10px; }
.header h1 { flex:1; color:#0f3d0f; font-size:20px; }
.back-link { text-decoration:none; color:#39b54a; font-weight:bold; }

/* ====== LAYOUT ====== */
.container { display:flex; height: calc(100vh - 60px); }

/* ====== SIDEBAR ====== */
.sidebar {
  position: fixed;
  left: -280px; /* hidden initially */
  top: 60px; /* below header */
  width: 280px;
  height: calc(100% - 60px);
  background:#0f3d0f;
  color:#e6f4ea;
  flex-direction: column;
  transition: left 0.3s ease;
  z-index: 100;
  padding:20px;
}
.sidebar.open { left:0; }
.sidebar h3 { margin-bottom:15px; color:#39b54a; }
.sidebar ul { list-style:none; padding-left:0; }
.sidebar ul li { padding:8px 5px; border-bottom:1px solid #2e8b3a; cursor:pointer; }
.sidebar ul li:hover { background:#2e8b3a; }

/* ====== CHAT AREA ====== */
.chat-area {
  flex:1;
  margin-left:0;
  padding:20px;
  overflow-y:auto;
  transition: margin-left 0.3s ease;
}
.sidebar.open ~ .chat-area { margin-left:280px; }

.chat-header { font-weight:bold; margin-bottom:10px; color:#0f3d0f; }
.chat-messages { height:70%; overflow-y:auto; border:1px solid #39b54a; border-radius:8px; padding:10px; background:#f9fff9; margin-bottom:10px; }
.chat-input { display:flex; }
.chat-input input { flex:1; padding:10px; border-radius:5px 0 0 5px; border:1px solid #39b54a; outline:none; }
.chat-input button { padding:10px; border:none; background:#39b54a; color:white; border-radius:0 5px 5px 0; cursor:pointer; }

/* ====== RESPONSIVE ====== */
@media(max-width:768px){
  .chat-area { margin-left:0; }
}
</style>
</head>
<body>

<!-- HEADER -->
<div class="header">
  <button class="hamburger" onclick="toggleSidebar()">☰</button>
  <img src="https://vtpsruejncfykiazrfsx.supabase.co/storage/v1/object/public/PRODUCTS/EYES%20OF%203080%20logo" alt="Logo" class="header-logo">
  <h1>FRIENDS</h1>
  <a href="3080.html" class="back-link">Home</a>
</div>

<!-- MAIN CONTAINER -->
<div class="container">
  <!-- SIDEBAR -->
  <div class="sidebar" id="sidebar">
    <h3>Friends List</h3>
    <ul id="friendsList">
      <li>Loading users...</li>
    </ul>
  </div>

  <!-- CHAT AREA -->
  <div class="chat-area">
    <div class="chat-header" id="chatWith">Select a friend to chat</div>
    <div class="chat-messages" id="chatMessages"></div>
    <div class="chat-input">
      <input type="text" id="messageInput" placeholder="Type a message...">
      <button onclick="sendMessage()">Send</button>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
const supabaseUrl = 'https://vtpsruejncfykiazrfsx.supabase.co';
const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZ0cHNydWVqbmNmeWtpYXpyZnN4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY3NDA5NzQsImV4cCI6MjA3MjMxNjk3NH0.UV55gbsSAgnyolxJhIYTaJUpvoJFsJn0_-LMNwhwAK0'; // Replace with your Supabase anon key
const supabase = supabase.createClient(supabaseUrl, supabaseKey);

// ====== SIDEBAR TOGGLE ======
function toggleSidebar(){
  const sidebar = document.getElementById('sidebar');
  sidebar.classList.toggle('open');
}


// ====== LOAD FRIENDS ======
async function loadFriends() {
  try {
    // Call your edge function that returns all users
    const res = await fetch('https://vtpsruejncfykiazrfsx.supabase.co/functions/v1/Sync-profiles');
    const data = await res.json();

    if (data.error) {
      console.error("❌ Error fetching friends:", data.error);
      return;
    }

    const users = data.users || [];
    const friendsList = document.getElementById('friendsList');
    friendsList.innerHTML = '';

    if (users.length === 0) {
      friendsList.innerHTML = '<li>No users found.</li>';
      return;
    }

    users.forEach(u => {
      const li = document.createElement('li');
      li.className = 'friend-item';
      li.innerHTML = `
        <img src="https://vtpsruejncfykiazrfsx.supabase.co/storage/v1/object/public/PRODUCTS/EYES%20OF%203080%20logo" 
             alt="User Logo" class="friend-logo">
        <span>${u.full_name || u.email}</span>
      `;
      li.onclick = () => selectFriend(u);
      friendsList.appendChild(li);
    });
  } catch (err) {
    console.error("❌ Failed to load friends:", err);
  }
}

// ====== SELECT FRIEND ======
let currentFriend = null;
function selectFriend(user){
  currentFriend = user;
  document.getElementById('chatWith').textContent = 'Chatting with: ' + (user.user_metadata?.full_name || user.email);
  document.getElementById('chatMessages').innerHTML = '';
  loadMessages(user);
}

// ====== LOAD MESSAGES ======
async function loadMessages(user){
  // Implement messages retrieval from Supabase table
  // Example: messages table with columns: sender_id, receiver_id, message, created_at
  const { data: messages, error } = await supabase.from('messages')
    .select('*')
    .or(`sender_id.eq.${user.id},receiver_id.eq.${user.id}`)
    .order('created_at', { ascending:true });

  if(error){ console.error(error); return; }

  const messagesDiv = document.getElementById('chatMessages');
  messagesDiv.innerHTML = '';
  messages.forEach(m => {
    const div = document.createElement('div');
    div.textContent = `${m.sender_id === currentFriend.id ? 'Them' : 'You'}: ${m.message}`;
    messagesDiv.appendChild(div);
  });
}

// ====== SEND MESSAGE ======
async function sendMessage(){
  const msgInput = document.getElementById('messageInput');
  if(!msgInput.value || !currentFriend) return;
  
  const { data, error } = await supabase.from('messages').insert([{
    sender_id: (await supabase.auth.getUser()).data.user.id,
    receiver_id: currentFriend.id,
    message: msgInput.value,
    created_at: new Date()
  }]);
  
  if(error){ console.error(error); return; }
  msgInput.value = '';
  loadMessages(currentFriend);
}

// Load friends on page load
document.addEventListener('DOMContentLoaded', loadFriends);
</script>
</body>
</html>