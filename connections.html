<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>FRIENDS - Eyes of 3080</title>
<style>
/* ====== GENERAL RESET ====== */
* { margin:0; padding:0; box-sizing:border-box; font-family: Arial, sans-serif; }

/* ====== HEADER ====== */
.header {
  display:flex;
  align-items:center;
  padding:10px 15px;
  background:#e6f4ea;
  border-bottom:2px solid #39b54a;
  position: sticky;
  top:0;
  z-index:100;
}
.hamburger { font-size:24px; background:none; border:none; color:#0f3d0f; cursor:pointer; margin-right:10px; }
.header-logo { width:40px; margin-right:10px; }
.header h1 { flex:1; color:#0f3d0f; font-size:20px; }
.back-link { text-decoration:none; color:#39b54a; font-weight:bold; }

/* ====== LAYOUT ====== */
.container { display:flex; height: calc(100vh - 60px); }

/* ====== SIDEBAR ====== */
.sidebar {
  position: fixed;
  left: -280px; /* hidden initially */
  top: 60px; /* below header */
  width: 280px;
  height: calc(100% - 60px);
  background:#0f3d0f;
  color:#e6f4ea;
  flex-direction: column;
  transition: left 0.3s ease;
  z-index: 100;
  padding:20px;
}
.sidebar.open { left:0; }
.sidebar h3 { margin-bottom:15px; color:#39b54a; }

/* Add Friend Form Styles */
#addFriendForm { margin-bottom:20px; background:#1e501e; padding:15px; border-radius:8px; }
#addFriendForm h4 { color:#39b54a; margin-bottom:10px; }
#addFriendForm input { width:100%; padding:8px; margin-bottom:8px; border-radius:5px; border:none; }
#addFriendForm button { width:100%; padding:8px; border:none; background:#39b54a; color:white; font-weight:bold; cursor:pointer; border-radius:5px; }

.sidebar ul { list-style:none; padding-left:0; }
.sidebar ul li { padding:8px 5px; border-bottom:1px solid #2e8b3a; cursor:pointer; }
.sidebar ul li:hover { background:#2e8b3a; }

/* ====== CHAT AREA ====== */
.chat-area {
  flex:1;
  margin-left:0;
  padding:20px;
  overflow-y:auto;
  transition: margin-left 0.3s ease;
}
.sidebar.open ~ .chat-area { margin-left:280px; }

.chat-header { font-weight:bold; margin-bottom:10px; color:#0f3d0f; }
.chat-messages { height:70%; overflow-y:auto; border:1px solid #39b54a; border-radius:8px; padding:10px; background:#f9fff9; margin-bottom:10px; }
.chat-input { display:flex; }
.chat-input input { flex:1; padding:10px; border-radius:5px 0 0 5px; border:1px solid #39b54a; outline:none; }
.chat-input button { padding:10px; border:none; background:#39b54a; color:white; border-radius:0 5px 5px 0; cursor:pointer; }

/* ====== RESPONSIVE ====== */
@media(max-width:768px){
  .chat-area { margin-left:0; }
}
</style>
</head>
<body>

<!-- HEADER -->
<div class="header">
  <button class="hamburger" onclick="toggleSidebar()">☰</button>
  <img src="https://vtpsruejncfykiazrfsx.supabase.co/storage/v1/object/public/PRODUCTS/EYES%20OF%203080%20logo" alt="Logo" class="header-logo">
  <h1>FRIENDS</h1>
  <a href="3080.html" class="back-link">Home</a>
</div>

<!-- MAIN CONTAINER -->
<div class="container">
  <!-- SIDEBAR -->
  <div class="sidebar" id="sidebar">
    <!-- Add Friend Form -->
    <div id="addFriendForm">
      <h4>Add Friend</h4>
      <input type="text" id="friendName" placeholder="Name">
      <button onclick="addFriend()">Add Friend</button>
    </div>

    <h3>Friends List</h3>
    <ul id="friendsList">
      <li>Loading users...</li>
    </ul>
  </div>

  <!-- CHAT AREA -->
  <div class="chat-area">
    <div class="chat-header" id="chatWith">Select a friend to chat</div>
    <div class="chat-messages" id="chatMessages"></div>
    <div class="chat-input">
      <input type="text" id="messageInput" placeholder="Type a message...">
      <button onclick="sendMessage()">Send</button>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
const supabaseUrl = 'https://vtpsruejncfykiazrfsx.supabase.co';
const supabaseKey = 'YOUR_SUPABASE_SERVICE_KEY'; // Use your service role key here
const supabase = supabase.createClient(supabaseUrl, supabaseKey);

// ====== SIDEBAR TOGGLE ======
function toggleSidebar(){
  const sidebar = document.getElementById('sidebar');
  sidebar.classList.toggle('open');
}

// ====== ADD FRIEND ======
async function addFriend(){
  const name = document.getElementById('friendName').value.trim();

  if(!name){
    alert("Please enter a name");
    return;
  }

  const user = (await supabase.auth.getUser()).data.user;
  if(!user) return alert("You must be logged in");

  const { data, error } = await supabase.from('friends').insert([{
    owner_id: user.id,
    name,
    logo: 'https://vtpsruejncfykiazrfsx.supabase.co/storage/v1/object/public/PRODUCTS/EYES%20OF%203080%20logo'
  }]);

  if(error){ console.error(error); alert("Failed to add friend"); return; }

  document.getElementById('friendName').value = '';

  loadFriends();
}

// ====== LOAD FRIENDS ======
async function loadFriends() {
  try {
    const user = (await supabase.auth.getUser()).data.user;
    if(!user) return;

    const { data: friends, error } = await supabase.from('friends').select('*').eq('owner_id', user.id);
    if(error){ console.error(error); return; }

    const friendsList = document.getElementById('friendsList');
    friendsList.innerHTML = '';

    if(friends.length === 0){
      friendsList.innerHTML = '<li>No friends found.</li>';
      return;
    }

    friends.forEach(f => {
      const li = document.createElement('li');
      li.className = 'friend-item';
      li.innerHTML = `
        <img src="${f.logo}" alt="User Logo" class="friend-logo" style="width:30px; height:30px; border-radius:50%; margin-right:8px;">
        <span>${f.name} (${f.email})</span>
      `;
      li.onclick = () => selectFriend(f);
      friendsList.appendChild(li);
    });
  } catch (err) {
    console.error("❌ Failed to load friends:", err);
  }
}

// ====== SELECT FRIEND ======
let currentFriend = null;
function selectFriend(friend){
  currentFriend = friend;
  document.getElementById('chatWith').textContent = 'Chatting with: ' + friend.name;
  document.getElementById('chatMessages').innerHTML = '';
  loadMessages(friend);
}

// ====== LOAD MESSAGES ======
async function loadMessages(friend){
  const { data: messages, error } = await supabase.from('messages')
    .select('*')
    .or(`sender_id.eq.${friend.id},receiver_id.eq.${friend.id}`)
    .order('created_at', { ascending:true });

  if(error){ console.error(error); return; }

  const messagesDiv = document.getElementById('chatMessages');
  messagesDiv.innerHTML = '';
  messages.forEach(m => {
    const div = document.createElement('div');
    div.textContent = `${m.sender_id === currentFriend.id ? 'Them' : 'You'}: ${m.message}`;
    messagesDiv.appendChild(div);
  });
}

// ====== SEND MESSAGE ======
async function sendMessage(){
  const msgInput = document.getElementById('messageInput');
  if(!msgInput.value || !currentFriend) return;

  const user = (await supabase.auth.getUser()).data.user;

  const { data, error } = await supabase.from('messages').insert([{
    sender_id: user.id,
    receiver_id: currentFriend.id,
    message: msgInput.value,
    created_at: new Date()
  }]);

  if(error){ console.error(error); return; }
  msgInput.value = '';
  loadMessages(currentFriend);
}

// Load friends on page load
document.addEventListener('DOMContentLoaded', loadFriends);
</script>
</body>
</html>