<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Your Downloads | EYES OF 3080</title>
<link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>
<style>
body { font-family:Segoe UI,Tahoma,sans-serif; background:#f4f6f5; margin:0; color:#222; }

/* Header */
header { background:linear-gradient(135deg,#2d5016,#4a7c2a); color:#fff; position:sticky; top:0; z-index:1000; }
.header-container { max-width:1200px; margin:auto; padding:15px 20px; display:flex; justify-content:space-between; align-items:center; }
.logo-wrap { display:flex; align-items:center; gap:10px; text-decoration:none; }
.logo-img { width:38px; height:38px; object-fit:contain; }
.logo-text { font-size:1.5rem; font-weight:bold; color:#fff; }
/* Hamburger */
.hamburger{border:none;background:none;cursor:pointer;display:flex;flex-direction:column;gap:5px;}
.hamburger span{width:28px;height:3px;background:#fff;border-radius:3px;transition:.3s;}
.hamburger.active span:nth-child(1){transform:rotate(45deg) translate(6px,6px)}
.hamburger.active span:nth-child(2){opacity:0}
.hamburger.active span:nth-child(3){transform:rotate(-45deg) translate(6px,-6px)}
/* Sidebar */
.sidebar{position:fixed;top:0;right:-300px;width:300px;height:100vh;background:#2d5016;transition:.3s;z-index:2000;}
.sidebar.active{right:0;}
.sidebar-header{display:flex;justify-content:space-between;align-items:center;padding:20px;color:#fff;border-bottom:1px solid rgba(255,255,255,.2);}
.close-btn{background:none;border:none;color:#fff;font-size:2rem;cursor:pointer;}
.nav-menu{list-style:none;padding:0;margin:0;}
.nav-menu a{display:block;padding:15px 20px;color:#fff;text-decoration:none;}
.nav-menu a:hover{background:rgba(255,255,255,.1);}
.overlay{position:fixed;inset:0;background:rgba(0,0,0,.5);display:none;z-index:1500;}
.overlay.active{display:block;}

/* Downloads container */
.downloads-title { font-size:1.5rem; font-weight:700; color:#14532d; margin-bottom:20px; }
.container { max-width:900px; margin:30px auto; padding:0 20px; }
.download-card {
  background:#fff;
  border-radius:18px;
  padding:20px;
  display:flex;
  justify-content:space-between;
  align-items:center;
  margin-bottom:16px;
  gap:16px;
  box-shadow:0 12px 30px rgba(0,0,0,.1);
  transition:transform .2s;
}
.download-card:hover { transform:translateY(-3px); }

.download-info { display:flex; flex-direction:column; }
.download-info h4 {
  margin:0 0 6px;
  font-size:1rem;
  color:#14532d;
  display:flex;
  align-items:center;
  gap:8px;
}
.download-info h4 i { color:#E53935; font-size:1.5rem; vertical-align:middle; }
.download-info p { margin:0; font-size:.85rem; color:#555; }

.download-btn {
  display:flex;
  align-items:center;
  gap:6px;
  padding:10px 14px;
  font-weight:600;
  border-radius:12px;
  background:#22c55e;
  color:#fff;
  border:none;
  cursor:pointer;
  transition:background .2s;
}
.download-btn:hover { background:#16a34a; }

.empty {
  background:#fff;
  padding:30px;
  border-radius:18px;
  text-align:center;
  box-shadow:0 10px 30px rgba(0,0,0,.08);
}

.error {
  background:#fff1f2;
  border:1px solid #fecaca;
  color:#991b1b;
  padding:18px;
  border-radius:16px;
  font-size:.9rem;
  line-height:1.5;
  white-space:pre-wrap;
}
</style>
</head>
<body>

<header>
  <div class="header-container">
    <a href="index.html" class="logo-wrap">
      <img src="https://zvnovocoayqomdilidte.supabase.co/storage/v1/object/public/uploads/6a8f3e57-3d27-47f5-9b5e-22a7070fc442.jpeg" class="logo-img">
      <span class="logo-text">EYES OF 3080</span>
    </a>
    <button class="hamburger" id="hamburger"><span></span><span></span><span></span></button>
  </div>
</header>

<nav class="sidebar" id="sidebar">
  <div class="sidebar-header">
    <h3>Menu</h3>
    <button class="close-btn" id="closeBtn">&times;</button>
  </div>
  <ul class="nav-menu">
    <li><a href="news.html">Home</a></li>
    <li><a href="pdf.html">PDFs</a></li>
    <li><a href="cbt.html">CBT</a></li>
    <li><a href="marketplace.html">Marketplace</a></li>
    <li><a href="profile.html">Profile</a></li>
  </ul>
</nav>
<div class="overlay" id="overlay"></div>

<div class="container" id="downloadsContainer">
  <div class="empty">Loading downloads…</div>
</div>

<script>
const supabaseClient = supabase.createClient(
  "https://zvnovocoayqomdilidte.supabase.co",
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inp2bm92b2NvYXlxb21kaWxpZHRlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQwMDM2OTgsImV4cCI6MjA3OTU3OTY5OH0.PcpwASQ3RBRoQVIglxKz-yM3iuYMZMtyQJBh8QNHad8"
);

/* ===== Hamburger ===== */
const hamburger = document.getElementById("hamburger");
const sidebar   = document.getElementById("sidebar");
const overlay   = document.getElementById("overlay");
const closeBtn  = document.getElementById("closeBtn");
function toggleMenu(){ hamburger.classList.toggle("active"); sidebar.classList.toggle("active"); overlay.classList.toggle("active"); }
hamburger.addEventListener("click", toggleMenu);
closeBtn.addEventListener("click", toggleMenu);
overlay.addEventListener("click", toggleMenu);
document.querySelectorAll(".nav-menu a").forEach(link=>link.addEventListener("click", toggleMenu));

/* ===== Download PDF ===== */
async function downloadPDF(fileUrl, fileName, btn) {
  try {
    const originalText = btn.innerHTML;
    btn.innerHTML = `<span class="material-icons">download</span> Downloading...`;
    btn.disabled = true;

    // Log download in Supabase
    const { data: authData } = await supabaseClient.auth.getUser();
    if(!authData.user) throw new Error("Login required to download files");
    const userId = authData.user.id;

    await supabaseClient.from("downloads").insert([{
      user_id: userId,
      file_id: btn.dataset.fileId,
      downloaded_at: new Date()
    }]);

    // Fetch the file
    const res = await fetch(fileUrl);
    if(!res.ok) throw new Error("Failed to fetch file");
    const blob = await res.blob();
    const blobUrl = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = blobUrl;
    a.download = fileName;
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(blobUrl);

    btn.innerHTML = originalText;
    btn.disabled = false;

    // Refresh downloads list
    loadDownloads();
  } catch(err) {
    console.error("Download error:", err);
    alert("Failed to download: " + err.message);
    btn.innerHTML = `<span class="material-icons">download</span> Download`;
    btn.disabled = false;
  }
}

/* ===== Load Downloads ===== */
async function loadDownloads() {
  const container = document.getElementById("downloadsContainer");

  try {
    const { data: authData } = await supabaseClient.auth.getUser();
    if (!authData.user) {
      container.innerHTML = `<div class="empty"><h3>Not logged in</h3><p>Please login to view your downloads.</p></div>`;
      return;
    }

    const userId = authData.user.id;

    const { data, error } = await supabaseClient
      .from("downloads")
      .select(`downloaded_at, course_files (id, course_code, title, file_url)`)
      .eq("user_id", userId)
      .order("downloaded_at", { ascending: false });

    if (error) throw error;

    if (!data || data.length === 0) {
      container.innerHTML = `<div class="empty"><h3>No downloads yet</h3><p>Files you download will appear here.</p></div>`;
      return;
    }

    container.innerHTML = `<h2 class="downloads-title">Your Downloads</h2>`;

    data.forEach(row => {
      if (!row.course_files) return;

      const card = document.createElement("div");
      card.className = "download-card";
      card.innerHTML = `
        <div class="download-info">
          <h4>
            <i class="material-icons">picture_as_pdf</i>
            ${row.course_files.course_code} — ${row.course_files.title}
          </h4>
          <p>Downloaded on ${new Date(row.downloaded_at).toLocaleString()}</p>
        </div>
        <button class="download-btn" data-file-id="${row.course_files.id}"
          onclick="downloadPDF('${row.course_files.file_url}', '${row.course_files.title.replace(/\s+/g,'_')}.pdf', this)">
          <span class="material-icons">download</span> Download
        </button>
      `;
      container.appendChild(card);
    });

  } catch(err) {
    console.error("Error loading downloads:", err);
    container.innerHTML = `<div class="error">Failed to load downloads.<br>${err.message}</div>`;
  }
}

// Initial load
loadDownloads();
</script>
</body>
</html>
