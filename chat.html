<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Eyes of 3080 Chat</title>
<style>
:root {
  --uni-green: #006400;
  --bg: #f6f7f8;
  --card: #fff;
}
* { box-sizing: border-box; }
body {
  margin: 0;
  font-family: "Poppins", Arial, sans-serif;
  background: var(--bg);
  color: #222;
}

/* HEADER */
header.site-header {
  background: var(--uni-green);
  color: #fff;
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 12px 16px;
}
.brand {
  display: flex;
  align-items: center;
  gap: 10px;
}
.brand img {
  width: 40px;
  height: 40px;
  border-radius: 50%;
  object-fit: cover;
}
.brand h1 {
  margin: 0;
  font-size: 18px;
  font-weight: 700;
  color: #fff;
}
.header-actions {
  display: flex;
  align-items: center;
  gap: 12px;
}
.header-actions button {
  background: transparent;
  border: none;
  cursor: pointer;
}
.header-actions button img {
  width: 22px;
  height: 22px;
  filter: brightness(0); /* makes icons black */
}

/* BACK BUTTON */
.btn-back {
  background: transparent;
  color: #000;
  border: none;
  font-weight: 700;
  cursor: pointer;
  font-size: 15px;
}

/* PAGE SECTIONS */
main {
  padding-bottom: 60px; /* leave space for bottom nav */
}
section {
  display: none;
  padding: 16px;
}
section.active {
  display: block;
}



/* BOTTOM NAV */
.bottom-nav {
  position: fixed;
  bottom: 0;
  left: 0;
  width: 100%;
  background: #fff;
  border-top: 1px solid #ddd;
  display: flex;
  justify-content: space-around;
  z-index: 100;
}
.nav-item {
  border: none;
  background: none;
  flex: 1;
  text-align: center;
  padding: 8px 0;
  cursor: pointer;
}
.nav-item img {
  width: 22px;
  height: 22px;
  display: block;
  margin: 0 auto 4px;
  opacity: 0.6;
  transition: all 0.2s;
}
.nav-item span {
  font-size: 12px;
  color: #333;
}
.nav-item.active img {
  opacity: 1;
  transform: scale(1.1);
}
.nav-item.active span {
  color: var(--uni-green);
  font-weight: 600;
}

/* MODAL */
.modal {
  display: none;
  position: fixed;
  inset: 0;
  background: rgba(0, 0, 0, 0.4);
  justify-content: center;
  align-items: center;
  z-index: 1000;
}
.modal-content {
  background: #fff;
  padding: 20px;
  border-radius: 10px;
  width: 90%;
  max-width: 400px;
}
.modal-content h3 {
  margin-top: 0;
  text-align: center;
}
.modal-content input,
.modal-content select {
  width: 100%;
  padding: 10px;
  margin: 6px 0;
  border-radius: 8px;
  border: 1px solid #ccc;
}
.modal-content .btn-row {
  display: flex;
  justify-content: space-between;
  margin-top: 10px;
}
.modal-content button {
  padding: 8px 14px;
  border: none;
  border-radius: 6px;
  cursor: pointer;
}
.modal-content button#cancelAdd {
  background: #ccc;
}
.modal-content button[type="submit"] {
  background: var(--uni-green);
  color: #fff;
}

/* ======================
   üí¨ Chat UI (WhatsApp Style)
====================== */

/* User list vertical */
#userList {
  display: flex;
  flex-direction: column;
  padding: 0;
  margin: 0;
  overflow-y: auto;
  height: 100%;
}

.user-card {
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: 12px;
  padding: 12px 16px;
  border-bottom: 1px solid #f0f0f0;
  cursor: pointer;
  transition: background 0.2s, transform 0.1s;
  background: #fff;
}

.user-card:hover {
  background: #f9f9f9;
  transform: translateY(-1px);
}

.user-card img.avatar {
  width: 48px;
  height: 48px;
  border-radius: 50%;
  object-fit: cover;
  flex-shrink: 0;
}

.user-info {
  flex: 1;
  display: flex;
  flex-direction: column;
  min-width: 0;
}

.user-name {
  font-weight: 600;
  font-size: 15.5px;
  color: #333;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

.campus-name {
  font-size: 13px;
  color: #777;
  margin-top: 2px;
}

.unread-badge {
  background: #ff3b30;
  color: #fff;
  border-radius: 50%;
  font-size: 12px;
  min-width: 20px;
  height: 20px;
  display: none;
  align-items: center;
  justify-content: center;
  font-weight: 600;
  margin-left: 8px;
}

.campus-logo {
  width: 30px;
  height: 30px;
  border-radius: 50%;
  object-fit: cover;
  margin-left: 12px;
  flex-shrink: 0;
  border: 1px solid #e6e6e6;
  background: #fff;
  transition: transform 0.2s ease;
  box-shadow: 0 1px 3px rgba(0,0,0,0.06);
}

/* Subtle hover scale for logo */
.user-card:hover .campus-logo {
  transform: scale(1.08);
}

/* Chat header campus badge */
.chat-header .campus-badge {
  width: 34px;
  height: 34px;
  border-radius: 50%;
  margin-left: 10px;
  object-fit: cover;
  border: 1px solid #eee;
  background: #fff;
}

/* Full chat room layout */
.chat-room {
  display: flex;
  flex-direction: column;
  height: 100vh;
  background: #f5f5f5;
  position: relative;
  overflow: hidden;
}

/* Watermark */
.chat-room::before {
  content: "EYES OF 3080";
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%) rotate(-30deg);
  font-size: 60px;
  color: rgba(0,0,0,0.03);
  user-select: none;
  pointer-events: none;
  white-space: nowrap;
}

/* Header */
.chat-header {
  display: flex;
  align-items: center;
  gap: 10px;
  padding: 10px 14px;
  background: #f7f7f7;
  border-bottom: 1px solid #ddd;
  flex-shrink: 0;
  position: sticky;
  top: 0;
  z-index: 2;
}

.back-btn {
  background: transparent;
  border: none;
  cursor: pointer;
  padding: 6px;
}

.back-btn img {
  width: 22px;
  height: 22px;
}

.chat-avatar {
  width: 42px;
  height: 42px;
  border-radius: 50%;
  object-fit: cover;
}

.chat-header-info {
  display: flex;
  flex-direction: column;
}

.chat-title {
  font-size: 16px;
  font-weight: 600;
  color: #111;
  margin: 0;
}

.chat-status {
  font-size: 13px;
  color: #777;
  display: flex;
  align-items: center;
  gap: 6px;
}

.shield-icon {
  font-size: 14px;
}

.online-dot {
  width: 7px;
  height: 7px;
  background: #4caf50;
  border-radius: 50%;
  display: inline-block;
}

.checkmark {
  color: #128c7e;
}

/* Messages container */
.messages {
  flex: 1;
  overflow-y: auto;
  padding: 14px;
  display: flex;
  flex-direction: column;
  gap: 8px;
  scroll-behavior: smooth;
  background: #f5f5f5;
}

/* Bubbles */
.msg {
  max-width: 75%;
  padding: 10px 14px;
  border-radius: 18px;
  word-wrap: break-word;
  font-size: 14px;
  line-height: 1.4;
  position: relative;
}

.msg.sent {
  background: #dcf8c6;
  align-self: flex-end;
  border-bottom-right-radius: 4px;
}

.msg.received {
  background: #fff;
  align-self: flex-start;
  border-bottom-left-radius: 4px;
}

/* Message ticks */
.msg.sent::after {
  content: "‚úî";
  font-size: 12px;
  position: absolute;
  bottom: 4px;
  right: 6px;
  color: gray;
}

.msg.sent.online::after {
  content: "‚úî‚úî";
  color: #128c7e;
}
/* Input bar (fixed above bottom nav) */
.chat-input {
  position: fixed;
  bottom: 60px; /* Height of your bottom nav bar */
  left: 0;
  width: 100%;
  display: flex;
  align-items: center;
  gap: 8px;
  padding: 10px 16px;
  background: #fff;
  border-top: 1px solid #ddd;
  z-index: 1000;
}

/* Input box styling */
.chat-input input {
  flex: 1;
  padding: 10px 14px;
  border-radius: 20px;
  border: 1px solid #ccc;
  outline: none;
  font-size: 14px;
}


.chat-input input {
  flex: 1;
  padding: 10px 14px;
  border-radius: 20px;
  border: 1px solid #ccc;
  outline: none;
  font-size: 14px;
}

/* Send button */
.send-btn {
  background: #25d366;
  border: none;
  width: 44px;
  height: 44px;
  border-radius: 50%;
  display: flex;
  justify-content: center;
  align-items: center;
  cursor: pointer;
  margin-left: 8px;
  z-index: 10001;           /* ensure it‚Äôs tappable */
}

/* Send icon */
.send-btn img {
  width: 22px;
  height: 22px;
  filter: invert(1);
}


/* Footer */
.chat-footer {
  text-align: center;
  font-size: 13px;
  color: #777;
  padding: 8px 0;
  background: #f9f9f9;
  border-top: 1px solid #eee;
  flex-shrink: 0;
}

.chat-footer .shield-icon {
  margin-right: 5px;
}

/* Scrollbar */
.messages::-webkit-scrollbar {
  width: 6px;
}

.messages::-webkit-scrollbar-thumb {
  background: rgba(0,0,0,0.2);
  border-radius: 3px;
}

/* ===== BACK BUTTON ===== */
.back-btn {
  background: none;
  border: none;
  outline: none;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  width: 38px;
  height: 38px;
  border-radius: 50%;
  transition: background 0.2s ease, transform 0.1s ease;
}

.back-btn:hover {
  background: rgba(0, 0, 0, 0.05);
  transform: scale(1.05);
}

.back-btn img {
  width: 20px;
  height: 20px;
  object-fit: contain;
}

/* Calls */
.call-item {
  display: flex;
  align-items: center;
  justify-content: space-between;
  background: #fff;
  border-radius: 10px;
  padding: 10px 14px;
  margin-bottom: 10px;
  box-shadow: 0 1px 2px rgba(0,0,0,0.1);
}
.call-item img:first-child {
  width: 42px;
  height: 42px;
  border-radius: 50%;
}
.call-info {
  flex: 1;
  margin-left: 12px;
}
.call-info h4 {
  margin: 0;
  font-size: 15px;
}
.call-info .muted {
  font-size: 12px;
  color: #777;
}
.call-icon {
  width: 22px;
  height: 22px;
  opacity: 0.7;
}


/* ======================
   üí¨ Updates / Recent Activity
====================== */
#updates {
  padding: 12px 16px;
}

.update-card {
  display: flex;
  align-items: center;
  gap: 12px;
  background: #fefefe;
  border-radius: 12px;
  padding: 10px 14px;
  margin-bottom: 12px;
  box-shadow: 0 2px 4px rgba(0,0,0,0.05);
  cursor: pointer;
  transition: transform 0.1s, box-shadow 0.2s;
}

.update-card:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 8px rgba(0,0,0,0.1);
}

.update-card img {
  width: 48px;
  height: 48px;
  border-radius: 50%;
  object-fit: cover;
}

.update-info {
  display: flex;
  flex-direction: column;
  flex: 1;
}

.update-title {
  font-weight: 600;
  font-size: 15px;
  color: #111;
  margin-bottom: 2px;
}

.update-text {
  font-size: 13px;
  color: #555;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
}

.update-time {
  font-size: 11px;
  color: #999;
  margin-left: auto;
  white-space: nowrap;
}

.section {
  padding: 12px 16px;
}

.section {
  padding: 12px 16px;
}

/* ===== SETTINGS SECTION ===== */
.settings-section {
  padding: 16px;
  background: #f7f7f7;
  min-height: 100%;
}

.settings-section h3 {
  margin-bottom: 16px;
  font-size: 18px;
  font-weight: 600;
}

/* Individual setting items */
.settings-item {
  background: #fff;
  border-radius: 12px;
  padding: 14px 16px;
  margin-bottom: 12px;
  box-shadow: 0 1px 3px rgba(0,0,0,0.1);
  display: flex;
  flex-direction: column;
  gap: 10px;
}

/* Avatar Section */
.avatar-preview {
  display: flex;
  align-items: center;
  gap: 12px;
}

.avatar-preview img {
  width: 50px;
  height: 50px;
  border-radius: 50%;
  object-fit: cover;
  border: 2px solid #128c7e;
}

#changeAvatarBtn {
  background: #128c7e;
  color: #fff;
  border: none;
  padding: 6px 12px;
  border-radius: 8px;
  cursor: pointer;
  font-weight: 600;
  transition: background 0.2s;
}

#changeAvatarBtn:hover {
  background: #0f765e;
}

/* Theme Section */
.theme-options {
  display: flex;
  gap: 12px;
  flex-wrap: wrap;
}

.theme-btn {
  flex: 1;
  min-width: 80px;
  padding: 12px 0;
  border-radius: 12px;
  border: none;
  cursor: pointer;
  color: #fff;
  font-weight: 600;
  text-align: center;
  transition: transform 0.1s, opacity 0.2s;
}

.theme-btn:hover {
  transform: scale(1.05);
  opacity: 0.9;
}

/* Chat storage / Clear all chats button */
#clearAllChatsBtn {
  background: #f44336;
  color: #fff;
  border: none;
  padding: 10px 0;
  border-radius: 12px;
  cursor: pointer;
  font-weight: 600;
  transition: background 0.2s;
}

#clearAllChatsBtn:hover {
  background: #d32f2f;
}

/* Chat Room Watermark */
.chat-room::before {
  content: "EYES OF 3080";
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%) rotate(-30deg);
  font-size: 60px;
  color: var(--watermark-color, rgba(0,0,0,0.03));
  pointer-events: none;
  user-select: none;
  z-index: 0;
}

/* Context menu for messages */
.msg-menu {
  position: absolute;
  background: #fff;
  border: 1px solid #ccc;
  border-radius: 8px;
  box-shadow: 0 2px 6px rgba(0,0,0,0.2);
  display: none;
  z-index: 1000;
  padding: 6px 0;
  min-width: 150px;
  font-size: 14px;
}

.msg-menu button {
  width: 100%;
  padding: 8px 12px;
  background: none;
  border: none;
  text-align: left;
  cursor: pointer;
}

.msg-menu button:hover {
  background: #f0f0f0;
}

/* Timestamp inside message bubble */
.msg .msg-time {
  display: block;
  font-size: 11px;
  color: rgba(0,0,0,0.4);
  text-align: right;
  margin-top: 4px;
}

</style>
</head>
<body>

<!-- ===== HEADER ===== -->
<header class="site-header">
  <div class="brand">
    <img src="https://i.postimg.cc/mD4BWXCk/6a8f3e57-3d27-47f5-9b5e-22a7070fc442.jpg" />
    <h1>EYES OF 3080</h1>
  </div>
  <div class="header-actions">
    <button id="addUserBtn"><img src="https://cdn-icons-png.flaticon.com/512/992/992651.png" alt="+" /></button>
<button class="btn-back" onclick="window.location.href='3080.html'">Back</button>
  </div>
</header>

<!-- ===== MAIN CONTENT ===== -->
<main>
  <!-- üí¨ CHATS SECTION -->
  <section id="chats" class="active">

    <!-- =======================
     USER LIST VIEW
======================= -->
<div id="userListView">
  <div id="userList"></div>
</div>

<!-- =======================
     CHAT ROOM VIEW (hidden initially)
======================= -->
<div class="chat-room" id="chatRoom" style="display:none; position: relative;">

  <!-- Chat Header -->
  <div class="chat-header">
    <button id="backToUsers" class="back-btn">
      <img src="https://cdn-icons-png.flaticon.com/512/271/271220.png" alt="Back">
    </button>

    <img id="roomAvatar" src="https://cdn-icons-png.flaticon.com/512/3135/3135715.png" alt="avatar" class="chat-avatar">

    <div class="chat-header-info">
      <h3 id="roomName" class="chat-title">The chop treat</h3>
      <div class="chat-status">
        <span class="shield-icon">üõ°Ô∏è</span>
        Secure Chat
        <span class="online-dot"></span>
        <span class="checkmark">‚úì</span>
      </div>
    </div>
  </div>

  <!-- Chat Messages -->
  <div id="messages" class="messages"></div>

  <!-- Chat Input -->
  <div class="chat-input">
    <input id="msgInput" type="text" placeholder="Type your message..." autocomplete="off">
    <button id="sendBtn" class="send-btn">
      <img src="https://cdn-icons-png.flaticon.com/512/724/724954.png" alt="Send">
    </button>
  </div>

  <!-- Secure Footer -->
  <div class="chat-footer">
    <span class="shield-icon">üõ°Ô∏è</span>
    Secure & monitored
  </div>
</div>

      <!-- Message Options Menu -->
      <div id="msgMenu" class="msg-menu" style="display:none; position:absolute; background:#fff; box-shadow:0 2px 6px rgba(0,0,0,0.2); border-radius:8px; z-index:100;">
        <button id="copyMsg">Copy Message</button>
        <button id="editMsg">Edit Message</button>
        <button id="deleteMe">Delete for Me</button>
        <button id="deleteEveryone">Delete for Everyone</button>
        <button id="pinMsg">Pin Message</button>
        <button id="clearChat">Clear Chat</button>
        <button id="deleteConv">Delete Conversation</button>
      </div>

      <!-- Faint Watermark -->
      <div class="chat-watermark">EYES OF 3080</div>

    </div>
  </section>



  <section id="calls">
  <h2>üìû Recent Calls</h2>
  <div class="call-item">
    <img src="https://cdn-icons-png.flaticon.com/512/3135/3135715.png" alt="user">
    <div class="call-info">
      <h4>Joy</h4>
      <p class="muted">Missed ‚Ä¢ Yesterday, 7:42 PM</p>
    </div>
    <img class="call-icon" src="https://cdn-icons-png.flaticon.com/512/597/597177.png" alt="Call">
  </div>
  <div class="call-item">
    <img src="https://cdn-icons-png.flaticon.com/512/1946/1946429.png" alt="user">
    <div class="call-info">
      <h4>Tunde</h4>
      <p class="muted">Outgoing ‚Ä¢ Today, 10:20 AM</p>
    </div>
    <img class="call-icon" src="https://cdn-icons-png.flaticon.com/512/597/597177.png" alt="Call">
  </div>
</section>

<section id="updates">
  <h3>Updates</h3>
  <div id="updatesList">
    <!-- Example update item -->
    <div class="update-card">
      <img src="https://i.postimg.cc/fbrgvkvP/IMG-1194.jpg" alt="avatar">
      <div class="update-info">
        <span class="update-title">Joy sent a new message</span>
        <span class="update-time">10:45 AM</span>
      </div>
    </div>
  </div>
</section>

<!-- ============================
     üåø SETTINGS / PROFILE SECTION
============================ -->
<section id="settings" class="settings-section">
  <h3>Settings</h3>

  <!-- Avatar -->
  <div class="settings-item">
    <label>Avatar</label>
    <div class="avatar-preview">
      <img id="userAvatarPreview" src="https://cdn-icons-png.flaticon.com/512/3135/3135715.png" alt="avatar">
      <input type="file" id="avatarInput" accept="image/*" style="display:none;">
    </div>
  </div>

  <!-- Chat Theme -->
  <div class="settings-item">
    <label>Chat Theme</label>
    <div class="theme-options">
      <button class="theme-btn" data-theme="default" style="background:#e5ddd5;">Default</button>
      <button class="theme-btn" data-theme="blue" style="background:#d0e6f7;">Blue</button>
      <button class="theme-btn" data-theme="pink" style="background:#f7d0e6;">Pink</button>
      <button class="theme-btn" data-theme="green" style="background:#d0f7d6;">Green</button>
    </div>
  </div>

  <!-- Clear Chat / Storage -->
  <div class="settings-item">
    <label>Chat Storage</label>
    <button id="clearAllChatsBtn">Clear All Chats</button>
  </div>
</section>
</main>

<!-- ===== BOTTOM NAVIGATION ===== -->
<nav class="bottom-nav">
  <button class="nav-item active" data-target="chats">
    <img src="https://cdn-icons-png.flaticon.com/512/134/134914.png" />
    <span>Chats</span>
  </button>
  <button class="nav-item" data-target="calls">
    <img src="https://cdn-icons-png.flaticon.com/512/597/597177.png" />
    <span>Calls</span>
  </button>
  <button class="nav-item" data-target="updates">
    <img src="https://cdn-icons-png.flaticon.com/512/1828/1828859.png" />
    <span>Updates</span>
  </button>
  <button class="nav-item" data-target="settings">
    <img src="https://cdn-icons-png.flaticon.com/512/126/126472.png" />
    <span>Settings</span>
  </button>
</nav>


<!-- ===== ADD USER MODAL ===== -->
<div class="modal" id="addUserModal" style="display:none;">
  <div class="modal-content">
    <h3>Start New Chat</h3>
    <form id="addUserForm">
      <input type="text" id="userName" placeholder="Full Name" required>
      <input type="email" id="userEmail" placeholder="User Email Address" required>

      <select id="userCampus" required>
        <option value="">Select Campus</option>
        <option>Osogbo(CSET)</option>
   <option>Osogbo(CHS)</option>
        <option>Okuku</option>
        <option>Ikire</option>
        <option>Ejigbo</option>
        <option>Ifetedo</option>
        <option>Ipetu-Ijesa</option>
      </select>

      <div class="btn-row">
        <button type="button" id="cancelAdd">Cancel</button>
        <button type="submit">Add User</button>
      </div>
    </form>
  </div>
</div>






<script type="module">
import { createClient } from 'https://esm.sh/@supabase/supabase-js@2';

const SUPABASE_URL = "https://vtpsruejncfykiazrfsx.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZ0cHNydWVqbmNmeWtpYXpyZnN4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY3NDA5NzQsImV4cCI6MjA3MjMxNjk3NH0.UV55gbsSAgnyolxJhIYTaJUpvoJFsJn0_-LMNwhwAK0";
const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

document.addEventListener("DOMContentLoaded", () => {

  // ==== ELEMENTS ====
  const userListContainer = document.getElementById("userList");
  const chatRoom = document.querySelector(".chat-room");
  const roomName = document.getElementById("roomName");
  const roomAvatar = document.getElementById("roomAvatar");
  const messagesEl = document.getElementById("messages");
  const backBtn = document.getElementById("backToUsers");
  const messageInput = document.getElementById("msgInput");
  const sendBtn = document.getElementById("sendBtn");

  let activeUser = null;
  let users = [];

  // ==== NAVIGATION ====
  const navItems = document.querySelectorAll(".nav-item");
  const sections = document.querySelectorAll("main section");
  navItems.forEach(item => {
    item.addEventListener("click", () => {
      navItems.forEach(btn => btn.classList.remove("active"));
      sections.forEach(sec => sec.classList.remove("active"));
      item.classList.add("active");
      document.getElementById(item.dataset.target).classList.add("active");
    });
  });

// ===== ADD USER MODAL (simple: adds directly to user_campus) =====
const addBtn = document.getElementById("addUserBtn");
const modal = document.getElementById("addUserModal");
const cancelAdd = document.getElementById("cancelAdd");
const form = document.getElementById("addUserForm");

addBtn?.addEventListener("click", () => {
  modal.style.display = "flex";
});

cancelAdd?.addEventListener("click", () => {
  modal.style.display = "none";
  form.reset();
});

form?.addEventListener("submit", async (e) => {
  e.preventDefault();

  const name = document.getElementById("userName")?.value?.trim();
  const email = document.getElementById("userEmail")?.value?.trim();
  const campus = document.getElementById("userCampus")?.value;

  if (!name || !email || !campus) {
    return alert("Please fill in all fields before adding a user.");
  }

  try {
    // Check if user already exists by email
    const { data: existing, error: checkError } = await supabase
      .from("user_campus")
      .select("*")
      .eq("email", email)
      .maybeSingle();

    if (checkError) throw checkError;

    if (existing) {
      alert("User already exists in user_campus.");
      modal.style.display = "none";
      form.reset();
      return;
    }

    // Insert new record
    const { error: insertError } = await supabase
      .from("user_campus")
      .insert([{ name, email, campus }]);

    if (insertError) throw insertError;

    alert("User added successfully!");
    modal.style.display = "none";
    form.reset();

    // Refresh user list if available
    if (typeof fetchUsers === "function") fetchUsers();
  } catch (err) {
    console.error("Add user error:", err);
    alert("Something went wrong. Please try again.");
  }
});

// Optional: close modal when user clicks outside
window.addEventListener("click", (e) => {
  if (e.target === modal) {
    modal.style.display = "none";
    form.reset();
  }
});

  // ==== CAMPUS LOGOS ====
  const campusLogos = {
    "Osogbo (CHS)": "https://vtpsruejncfykiazrfsx.supabase.co/storage/v1/object/public/uploads/9e8df984-270a-4e27-a31b-f2bb6f6aa2d2.jpeg",
    "Osogbo (CSET)": "https://vtpsruejncfykiazrfsx.supabase.co/storage/v1/object/public/uploads/668df17a-7bba-4a18-be0b-6c96feada4a1.jpeg",
    "Okuku": "https://vtpsruejncfykiazrfsx.supabase.co/storage/v1/object/public/uploads/683ed70e-e6bc-406f-8bfc-7012d8fc3ac0.jpeg",
    "Ifetedo": "https://vtpsruejncfykiazrfsx.supabase.co/storage/v1/object/public/uploads/b658c42f-7881-464f-b685-6baf751f52e3.jpeg",
    "Ikire": "https://vtpsruejncfykiazrfsx.supabase.co/storage/v1/object/public/uploads/b658c42f-7881-464f-b685-6baf751f52e3.jpeg",
    "Ejigbo": "https://vtpsruejncfykiazrfsx.supabase.co/storage/v1/object/public/uploads/IMG_1248.jpeg",
    "Ipetu-Ijesa": "https://vtpsruejncfykiazrfsx.supabase.co/storage/v1/object/public/uploads/IMG_1248.jpeg"
  };

  // ==== FETCH USERS ====
  async function fetchUsers() {
    try {
      const { data, error } = await supabase.from("user_campus").select("*");
      if (error) throw error;
      users = data;
      renderUsers();
    } catch (err) {
      console.error("Error fetching users:", err);
    }
  }

  // ==== RENDER USERS ====
  function renderUsers() {
    userListContainer.innerHTML = "";
    users.forEach(u => {
      const card = document.createElement("div");
      card.className = "user-card";
      const campusLogo = campusLogos[u.campus] || "";
      card.innerHTML = `
        <div class="user-info">
          <span class="user-name">${u.name}</span>
        </div>
        ${campusLogo ? `<img src="${campusLogo}" class="campus-logo" alt="${u.campus} logo">` : ""}
      `;
      card.onclick = () => openChat(u);
      userListContainer.appendChild(card);
    });
  }

  // ==== OPEN CHAT ====
  async function openChat(u) {
    activeUser = u;
    roomName.textContent = `${u.name}`;
    roomAvatar.src = campusLogos[u.campus] || "https://cdn-icons-png.flaticon.com/512/3135/3135715.png";
    chatRoom.style.display = "block";
    userListContainer.parentElement.style.display = "none";
    messagesEl.innerHTML = "";

    const { data: { user: currentUser } } = await supabase.auth.getUser();
    if (!currentUser) {
      alert("Please log in first.");
      window.location.href = "index.html";
      return;
    }

    const { data: msgs, error } = await supabase
      .from("messages")
      .select("*")
      .or(
        `and(sender_id.eq.${currentUser.id},receiver_id.eq.${u.user_id || u.id}),and(sender_id.eq.${u.user_id || u.id},receiver_id.eq.${currentUser.id})`
      )
      .order("created_at", { ascending: true });

    if (error) {
      console.error("Fetch chat error:", error);
      return;
    }

    msgs.forEach(msg => addMessageToDOM(msg, msg.sender_id === currentUser.id));

    await supabase
      .from("messages")
      .update({ read: true })
      .eq("sender_id", u.user_id || u.id)
      .eq("receiver_id", currentUser.id)
      .eq("read", false);

    updateUnreadCounts();
  }

  // ==== ADD MESSAGE TO DOM ====
  function addMessageToDOM(msg, sent) {
    const div = document.createElement("div");
    div.className = sent ? "message sent" : "message received";
    div.dataset.id = msg.id || Date.now();
    let ticks = "";
    if (sent) {
      ticks = msg.read ? `<span class="tick read">‚úî‚úî</span>` : `<span class="tick">‚úî</span>`;
    }
    div.innerHTML = `
      <div class="msg-bubble" data-id="${div.dataset.id}">
        <p>${msg.text}</p>
        <span class="msg-time">${new Date(msg.created_at).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}</span>
        ${ticks}
      </div>
    `;
    messagesEl.appendChild(div);
    messagesEl.scrollTop = messagesEl.scrollHeight;
  }

// ==== SEND MESSAGE ====

document.addEventListener("DOMContentLoaded", () => {
  const btn = document.getElementById("sendBtn");
  btn?.addEventListener("click", () => {
    alert("‚úÖ Working!");
  });
});




  // ==== MESSAGE MENU ====
  const msgMenu = document.getElementById("msgMenu");
  const copyBtn = document.getElementById("copyMsg");
  const editBtn = document.getElementById("editMsg");
  const deleteMeBtn = document.getElementById("deleteMe");
  const deleteEveryoneBtn = document.getElementById("deleteEveryone");
  const pinBtn = document.getElementById("pinMsg");
  const clearChatBtn = document.getElementById("clearChat");
  const deleteConvBtn = document.getElementById("deleteConv");

  let selectedMsg = null;
  let selectedMsgId = null;

  messagesEl.addEventListener("contextmenu", (e) => {
    const msgBubble = e.target.closest(".msg-bubble");
    if (!msgBubble) return;
    e.preventDefault();
    selectedMsgId = msgBubble.dataset.id;
    selectedMsg = msgBubble;
    msgMenu.style.display = "block";
    msgMenu.style.left = e.pageX + "px";
    msgMenu.style.top = e.pageY + "px";
  });

  document.addEventListener("click", (e) => {
    if (!msgMenu.contains(e.target)) msgMenu.style.display = "none";
  });

  copyBtn.addEventListener("click", () => {
    if (!selectedMsg) return;
    const text = selectedMsg.querySelector("p").textContent;
    navigator.clipboard.writeText(text);
    alert("Message copied ‚úÖ");
    msgMenu.style.display = "none";
  });

  editBtn.addEventListener("click", async () => {
    if (!selectedMsgId) return;
    const oldText = selectedMsg.querySelector("p").textContent;
    const newText = prompt("Edit your message:", oldText);
    if (newText === null || newText.trim() === "") return;

    const { error } = await supabase.from("messages").update({ text: newText }).eq("id", selectedMsgId);
    if (error) {
      console.error(error);
      alert("Failed to edit message.");
      return;
    }

    selectedMsg.querySelector("p").textContent = newText;
    msgMenu.style.display = "none";
  });

  deleteMeBtn.addEventListener("click", () => {
    if (!selectedMsgId) return;
    selectedMsg.remove();
    msgMenu.style.display = "none";
  });

  deleteEveryoneBtn.addEventListener("click", async () => {
    if (!selectedMsgId) return;
    const { error } = await supabase.from("messages").delete().eq("id", selectedMsgId);
    if (error) {
      console.error(error);
      alert("Failed to delete for everyone.");
      return;
    }
    selectedMsg.remove();
    msgMenu.style.display = "none";
  });

  pinBtn.addEventListener("click", () => {
    if (!selectedMsg) return;
    selectedMsg.classList.toggle("pinned");
    if (selectedMsg.classList.contains("pinned")) {
      selectedMsg.style.border = "2px solid gold";
      alert("Message pinned üìå");
    } else {
      selectedMsg.style.border = "none";
    }
    msgMenu.style.display = "none";
  });

  clearChatBtn.addEventListener("click", () => {
    if (!confirm("Are you sure you want to clear this chat?")) return;
    messagesEl.innerHTML = "";
    msgMenu.style.display = "none";
  });

  deleteConvBtn.addEventListener("click", async () => {
    if (!activeUser) return;
    if (!confirm("Delete this conversation completely?")) return;

    const { data: { user } } = await supabase.auth.getUser();

    const { error } = await supabase
      .from("messages")
      .delete()
      .or(`and(sender_id.eq.${user.id},receiver_id.eq.${activeUser.user_id}),and(sender_id.eq.${activeUser.user_id},receiver_id.eq.${user.id})`);

    if (error) {
      console.error(error);
      alert("Failed to delete conversation.");
      return;
    }

    messagesEl.innerHTML = "";
    alert("Conversation deleted.");
    msgMenu.style.display = "none";
  });

  // ==== UNREAD COUNTS ====
  async function updateUnreadCounts() {
    const { data: { user } } = await supabase.auth.getUser();
    if (!user) return;

    const { data: unreadMessages, error } = await supabase
      .from("messages")
      .select("sender_id, read")
      .eq("read", false)
      .neq("sender_id", user.id);

    if (error) return console.error(error);

    document.querySelectorAll(".unread-badge").forEach(b => {
      b.style.display = "none";
      b.textContent = "";
    });

    const counts = unreadMessages.reduce((acc, msg) => {
      acc[msg.sender_id] = (acc[msg.sender_id] || 0) + 1;
      return acc;
    }, {});

    Object.entries(counts).forEach(([senderId, count]) => {
      const badge = document.getElementById(`unread-${senderId}`);
      if (badge) {
        badge.textContent = count;
        badge.style.display = "flex";
      }
    });
  }

  setInterval(updateUnreadCounts, 5000);

  // ==== BACK BUTTON ====
  if (backBtn) {
    backBtn.onclick = () => {
      chatRoom.style.display = "none";
      userListContainer.parentElement.style.display = "block";
      activeUser = null;
    };
  }

  // ==== INITIALIZE ====
  fetchUsers();
});

</script>
</body>
</html>